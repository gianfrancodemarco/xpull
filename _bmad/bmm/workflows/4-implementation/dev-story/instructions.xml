<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>
  <critical>Execute ALL steps in exact order; do NOT skip steps</critical>
  <critical>Absolutely DO NOT stop because of "milestones", "significant progress", or "session boundaries". Continue in a single execution
    until the story is COMPLETE (all ACs satisfied and all tasks/subtasks checked) UNLESS a HALT condition is triggered or the USER gives
    other instruction.</critical>
  <critical>Do NOT schedule a "next session" or request review pauses unless a HALT condition applies. Only Step 9 decides completion.</critical>
  <critical>User skill level ({user_skill_level}) affects conversation style ONLY, not code updates.</critical>
  <critical>üêô ALL TRACKING IS ON GITHUB ‚Äî read story from GitHub issue, update labels, use branches and PRs</critical>

  <step n="1" goal="Find next ready story from GitHub and load it">
    <check if="{{story_issue_number}} is provided by user">
      <action>Fetch issue #{story_issue_number} from {github_owner}/{github_repo}</action>
      <action>Verify it has label `story`</action>
      <action>Read COMPLETE issue body</action>
      <action>Extract story_key from issue title</action>
      <goto anchor="github_setup" />
    </check>

    <!-- GitHub-based story discovery -->
    <action>Search GitHub issues on {github_owner}/{github_repo}: labels `story` + `ready-for-dev`, state: open</action>
    <action>Sort by issue number ascending (earliest first)</action>

    <check if="no ready-for-dev stories found">
      <!-- Try in-progress stories (resuming work) -->
      <action>Search GitHub issues: labels `story` + `in-progress`, state: open</action>
      <check if="in-progress story found">
        <action>Use the first in-progress story</action>
        <action>Set {{resuming}} = true</action>
        <goto anchor="github_setup" />
      </check>

      <output>üìã No ready-for-dev or in-progress stories found on GitHub.

        **What would you like to do?**
        1. Run `create-story` to enrich the next backlog story with dev context
        2. Specify a particular issue number to develop
        3. Check GitHub issues to see current status
      </output>
      <ask>Choose option [1], [2], or [3], or specify issue number:</ask>

      <check if="user chooses '1'">
        <action>HALT - Run create-story first</action>
      </check>
      <check if="user provides issue number">
        <action>Fetch that issue and continue</action>
      </check>
      <check if="user chooses '3'">
        <action>List all story issues with their labels, then HALT</action>
      </check>
    </check>

    <action>Select the FIRST ready-for-dev story issue</action>
    <action>Read COMPLETE issue body</action>
    <action>Extract story_key from title (e.g., "Story 1.2: User Auth" ‚Üí "1-2-user-auth")</action>
    <action>Set {{story_issue_number}}</action>

    <anchor id="github_setup" />

    <!-- Immediately assign issue to current user to signal work has started -->
    <action>Get current GitHub user (via get_me or gh api user) and assign issue #{story_issue_number} to them on {github_owner}/{github_repo}</action>

    <action>Parse issue body sections: Story, Acceptance Criteria, Tasks/Subtasks, Dev Notes, Dev Agent Record</action>
    <action>Load comprehensive context from Dev Notes section in the issue body</action>
    <action>Identify first incomplete task (unchecked [ ]) in Tasks/Subtasks</action>

    <action if="no incomplete tasks">
      <goto step="9">Completion sequence</goto>
    </action>
    <action if="issue body is empty or missing Dev Notes">HALT: "Story not enriched. Run create-story first to add dev context."</action>
  </step>

  <step n="2" goal="GitHub setup: assign and create branch">
    <critical>üêô SET UP THE GITHUB WORKFLOW ‚Äî assign issue, create branch (PR created after first commit)</critical>

    <!-- Get current user (issue already assigned in Step 1, store username for branch/PR use) -->
    <action>Get current GitHub user (via get_me or gh api user)</action>
    <action>Store as {{github_username}}</action>

    <!-- Confirm issue assignment (idempotent ‚Äî already assigned in Step 1) -->
    <action>Assign issue #{story_issue_number} to {{github_username}} on {github_owner}/{github_repo}</action>

    <!-- Update label to in-progress -->
    <action>Remove label `ready-for-dev` from issue #{story_issue_number}</action>
    <action>Add label `in-progress` to issue #{story_issue_number}</action>

    <!-- Create branch -->
    <action>Create branch `story/{{story_key}}` from the default branch on {github_owner}/{github_repo}</action>
    <action>Checkout the branch locally: `git fetch origin &amp;&amp; git checkout story/{{story_key}}`</action>

    <!-- PR will be created in Step 7 after the first commit is pushed -->
    <action>Set {{pr_number}} = null (draft PR created after first commit)</action>

    <output>üêô **GitHub Workflow Ready**
      - Issue #{story_issue_number} assigned to @{{github_username}}
      - Branch: `story/{{story_key}}`
      - Draft PR: will be created after first commit
      - Status: in-progress
    </output>

    <check if="{{resuming}} == true">
      <output>‚èØÔ∏è Resuming work on story {{story_key}}</output>
    </check>
    <check if="{{resuming}} != true">
      <output>üöÄ Starting fresh implementation of story {{story_key}}</output>
    </check>
  </step>

  <step n="3" goal="Load project context and detect review continuation">
    <critical>Load all available context to inform implementation</critical>

    <action>Load {project_context} for coding standards and project-wide patterns (if exists)</action>
    <action>Extract developer guidance from issue body Dev Notes section</action>
    <action>Use enhanced story context to inform implementation decisions</action>

    <!-- Check for review continuation -->
    <action>Check if issue body contains "Senior Developer Review (AI)" section</action>
    <check if="Senior Developer Review section exists">
      <action>Set review_continuation = true</action>
      <action>Extract review outcome, action items, severity breakdown</action>
      <action>Count unchecked review follow-up tasks</action>
      <output>‚èØÔ∏è **Resuming Story After Code Review**
        **Review Outcome:** {{review_outcome}}
        **Action Items:** {{unchecked_review_count}} remaining
        **Strategy:** Will prioritize review follow-up tasks first.
      </output>
    </check>
    <check if="no review section">
      <action>Set review_continuation = false</action>
    </check>
  </step>

  <step n="4" goal="Implement task following red-green-refactor cycle">
    <critical>FOLLOW THE ISSUE BODY TASKS/SUBTASKS SEQUENCE EXACTLY AS WRITTEN - NO DEVIATION</critical>

    <action>Review the current task/subtask from the issue body - this is your authoritative implementation guide</action>
    <action>Plan implementation following red-green-refactor cycle</action>

    <!-- RED PHASE -->
    <action>Write FAILING tests first for the task/subtask functionality</action>
    <action>Confirm tests fail before implementation</action>

    <!-- GREEN PHASE -->
    <action>Implement MINIMAL code to make tests pass</action>
    <action>Run tests to confirm they now pass</action>
    <action>Handle error conditions and edge cases</action>

    <!-- REFACTOR PHASE -->
    <action>Improve code structure while keeping tests green</action>
    <action>Ensure code follows architecture patterns from Dev Notes</action>

    <action if="new dependencies required beyond story specifications">HALT: "Additional dependencies need user approval"</action>
    <action if="3 consecutive implementation failures occur">HALT and request guidance</action>

    <critical>NEVER implement anything not mapped to a specific task/subtask</critical>
    <critical>NEVER proceed to next task until current task/subtask is complete AND tests pass</critical>
    <critical>Execute continuously without pausing until all tasks/subtasks are complete or explicit HALT</critical>
  </step>

  <step n="5" goal="Author comprehensive tests">
    <action>Create unit tests for business logic and core functionality</action>
    <action>Add integration tests for component interactions</action>
    <action>Include end-to-end tests for critical user flows when required</action>
    <action>Cover edge cases and error handling scenarios</action>
  </step>

  <step n="6" goal="Run validations and tests">
    <action>Determine how to run tests for this repo</action>
    <action>Run all existing tests to ensure no regressions</action>
    <action>Run the new tests to verify implementation</action>
    <action>Run linting and code quality checks if configured</action>
    <action>Validate implementation meets ALL acceptance criteria</action>
    <action if="regression tests fail">STOP and fix before continuing</action>
    <action if="new tests fail">STOP and fix before continuing</action>
  </step>

  <step n="7" goal="Commit, push, and validate task completion">
    <critical>NEVER mark a task complete unless ALL conditions are met</critical>

    <!-- VALIDATION GATES -->
    <action>Verify ALL tests for this task/subtask ACTUALLY EXIST and PASS 100%</action>
    <action>Confirm implementation matches EXACTLY what the task/subtask specifies</action>
    <action>Validate that ALL acceptance criteria related to this task are satisfied</action>
    <action>Run full test suite to ensure NO regressions</action>

    <!-- COMMIT AND PUSH -->
    <action>Stage changes: `git add .`</action>
    <action>Commit with descriptive message referencing the story: `git commit -m "feat({{story_key}}): {task_description}"`</action>
    <action>Push to branch: `git push origin story/{{story_key}}`</action>

    <!-- CREATE DRAFT PR (on first commit only) -->
    <check if="{{pr_number}} is null (no draft PR yet)">
      <action>Read the PR template from {pr_template}</action>
      <action>Create a draft pull request on {github_owner}/{github_repo}:
        - **Title:** Story {{story_key}}: {{story_title}}
        - **Head branch:** story/{{story_key}}
        - **Base branch:** default branch (usually main)
        - **Body:** Use PR template, replacing #{issue_number} with #{story_issue_number}
        - **Draft:** true
      </action>
      <action>Store {{pr_number}} for later use</action>
      <output>üêô Draft PR #{pr_number} created for story/{{story_key}}</output>
    </check>

    <!-- UPDATE ISSUE BODY: mark task complete -->
    <check if="ALL validation gates pass">
      <action>Update the GitHub issue #{story_issue_number} body: mark the completed task checkbox [x]</action>
      <action>Append to Dev Agent Record ‚Üí Completion Notes in the issue body</action>
      <action>Update File List section with changed files</action>
    </check>

    <check if="ANY validation fails">
      <action>DO NOT mark task complete - fix issues first</action>
      <action>HALT if unable to fix validation failures</action>
    </check>

    <action>Determine if more incomplete tasks remain</action>
    <action if="more tasks remain">
      <goto step="4">Next task</goto>
    </action>
    <action if="no tasks remain">
      <goto step="8">Completion</goto>
    </action>
  </step>

  <step n="8" goal="Final push and validation">
    <action>Verify ALL tasks and subtasks are marked [x] in the issue body</action>
    <action>Run the full regression suite</action>
    <action>Confirm File List in issue body includes every changed file</action>
    <action>Execute enhanced definition-of-done validation</action>

    <!-- Definition of Done Validation -->
    <action>Validate:
      - All tasks/subtasks marked complete with [x]
      - Implementation satisfies every Acceptance Criterion
      - Unit tests added/updated
      - Integration tests added when required
      - All tests pass (no regressions)
      - Code quality checks pass
      - File List in issue body is complete
      - Dev Agent Record contains implementation notes
    </action>

    <action if="any task is incomplete">HALT - Complete remaining tasks</action>
    <action if="regression failures exist">HALT - Fix regressions</action>
    <action if="definition-of-done fails">HALT - Address DoD failures</action>

    <!-- Final push -->
    <action>Push any remaining commits: `git push origin story/{{story_key}}`</action>
  </step>

  <step n="9" goal="Mark PR ready for review and update GitHub issue">
    <critical>üêô FINALIZE THE GITHUB WORKFLOW ‚Äî remove draft, update labels</critical>

    <!-- Mark PR ready for review (remove draft) -->
    <action>Update pull request #{pr_number} on {github_owner}/{github_repo}: set draft = false</action>

    <!-- Update issue labels -->
    <action>Remove label `in-progress` from issue #{story_issue_number}</action>
    <action>Add label `review` to issue #{story_issue_number}</action>

    <!-- Update issue body status -->
    <action>Update the issue body: set status to "review" in the Dev Agent Record section</action>

    <!-- Update PR body with final details -->
    <action>Update PR #{pr_number} body with:
      - Summary of changes
      - List of files changed
      - Testing details
      - Link to story issue
    </action>

    <output>‚úÖ **Story Implementation Complete!**

      **Story:** {{story_key}}
      **GitHub Issue:** #{story_issue_number} (now labeled `review`)
      **Pull Request:** #{pr_number} (ready for review)
      **Branch:** story/{{story_key}}

      **Next Steps:**
      1. Review the PR at https://github.com/{github_owner}/{github_repo}/pull/{{pr_number}}
      2. Run `code-review` workflow for AI-assisted review
      3. üí° **Tip:** Use a different LLM for code review than the one that implemented

    </output>
  </step>

  <step n="10" goal="User support">
    <action>Based on {user_skill_level}, ask if user needs explanations about:
      - What was implemented and how it works
      - Why certain technical decisions were made
      - How to test or verify the changes
      - Any patterns or approaches used
    </action>

    <check if="user asks for explanations">
      <action>Provide clear, contextual explanations tailored to {user_skill_level}</action>
    </check>

    <action>Remain flexible - allow user to choose their path</action>
  </step>

</workflow>
